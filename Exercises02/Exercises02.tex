%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass{article}

\usepackage{fancyhdr} % Required for custom headers
\usepackage{lastpage} % Required to determine the last page for the footer
\usepackage{extramarks} % Required for headers and footers
\usepackage[usenames,dvipsnames]{color} % Required for custom colors
\usepackage{graphicx} % Required to insert images
\usepackage{amsmath}
\usepackage{listings} % Required for insertion of code
%\usepackage{couriernew} % Required for the courier font

\usepackage{enumerate} % Required for enumerating with letters

% Margins
\topmargin=-0.45in
\evensidemargin=0in
\oddsidemargin=0in
\textwidth=6.5in
\textheight=9.0in
\headsep=0.25in

\linespread{1.1} % Line spacing

% Set up the header and footer
\pagestyle{fancy}
\lhead{\hmwkAuthorName} % Top left header
\chead{\hmwkClass\ : \hmwkTitle} % Top center head
\rhead{} % Top right header
\lfoot{\lastxmark} % Bottom left footer
\cfoot{} % Bottom center footer
\rfoot{Page\ \thepage\ of\ \protect\pageref{LastPage}} % Bottom right footer
\renewcommand\headrulewidth{0.4pt} % Size of the header rule
\renewcommand\footrulewidth{0.4pt} % Size of the footer rule

\setlength\parindent{0pt} % Removes all indentation from paragraphs

%----------------------------------------------------------------------------------------
%	CODE INCLUSION CONFIGURATION
%----------------------------------------------------------------------------------------

\definecolor{MyDarkGreen}{rgb}{0.0,0.4,0.0} % This is the color used for comments
\lstloadlanguages{R} % Load R syntax for listings, for a list of other languages supported see: ftp://ftp.tex.ac.uk/tex-archive/macros/latex/contrib/listings/listings.pdf
\lstset{language=R, % Use R in this example
        frame=single, % Single frame around code
        basicstyle=\small\ttfamily, % Use small true type font
        keywordstyle=[1]\color{Blue}, % Perl functions bold and blue
        keywordstyle=[2]\color{Purple}, % Perl function arguments purple
        keywordstyle=[3]\color{Blue}\underbar, % Custom functions underlined and blue
        identifierstyle=, % Nothing special about identifiers                                         
        commentstyle=\usefont{T1}{pcr}{m}{sl}\color{MyDarkGreen}\small, % Comments small dark green courier font
        stringstyle=\color{Purple}, % Strings are purple
        showstringspaces=false, % Don't put marks in string spaces
        tabsize=4, % 5 spaces per tab
        %
        % Put standard Perl functions not included in the default language here
        morekeywords={rand},
        %
        % Put Perl function parameters here
        morekeywords=[2]{on, off, interp},
        %
        % Put user defined functions here
        morekeywords=[3]{test},
       	%
        morecomment=[l][\color{Blue}]{...}, % Line continuation (...) like blue comment
        numbers=left, % Line numbers on left
        firstnumber=1, % Line numbers start with line 1
        numberstyle=\tiny\color{Blue}, % Line numbers are blue and small
        stepnumber=5 % Line numbers go in steps of 5
}

% Creates a new command to include a perl script, the first parameter is the filename of the script (without .pl), the second parameter is the caption
\newcommand{\rscript}[2]{
\begin{itemize}
\item[]\lstinputlisting[caption=#2,label=#1]{#1.r}
\end{itemize}
}

%----------------------------------------------------------------------------------------
%	DOCUMENT STRUCTURE COMMANDS
%	Skip this unless you know what you're doing
%----------------------------------------------------------------------------------------

% Header and footer for when a page split occurs within a problem environment
\newcommand{\enterProblemHeader}[1]{
\nobreak\extramarks{#1}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
}

% Header and footer for when a page split occurs between problem environments
\newcommand{\exitProblemHeader}[1]{
\nobreak\extramarks{#1 (continued)}{#1 continued on next page\ldots}\nobreak
\nobreak\extramarks{#1}{}\nobreak
}

\setcounter{secnumdepth}{0} % Removes default section numbers
\newcounter{homeworkProblemCounter} % Creates a counter to keep track of the number of problems

\newcommand{\homeworkProblemName}{}
\newenvironment{homeworkProblem}[1][Problem \arabic{homeworkProblemCounter}]{ % Makes a new environment called homeworkProblem which takes 1 argument (custom name) but the default is "Problem #"
\stepcounter{homeworkProblemCounter} % Increase counter for number of problems
\renewcommand{\homeworkProblemName}{#1} % Assign \homeworkProblemName the name of the problem
\section{\homeworkProblemName} % Make a section in the document with the custom problem count
\enterProblemHeader{\homeworkProblemName} % Header and footer within the environment
}{
\exitProblemHeader{\homeworkProblemName} % Header and footer after the environment
}

\newcommand{\problemAnswer}[1]{ % Defines the problem answer command with the content as the only argument
\noindent\framebox[\columnwidth][c]{\begin{minipage}{0.98\columnwidth}#1\end{minipage}} % Makes the box around the problem answer and puts the content inside
}

\newcommand{\homeworkSectionName}{}
\newenvironment{homeworkSection}[1]{ % New environment for sections within homework problems, takes 1 argument - the name of the section
\renewcommand{\homeworkSectionName}{#1} % Assign \homeworkSectionName to the name of the section from the environment argument
\subsection{\homeworkSectionName} % Make a subsection with the custom name of the subsection
\enterProblemHeader{\homeworkProblemName\ [\homeworkSectionName]} % Header and footer within the environment
}{
\enterProblemHeader{\homeworkProblemName} % Header and footer after the environment
}

%----------------------------------------------------------------------------------------
%	NAME AND CLASS SECTION
%----------------------------------------------------------------------------------------

\newcommand{\hmwkTitle}{Exercises 2 - Online Learning} % Assignment title
\newcommand{\hmwkDueDate}{\today} % Due date
\newcommand{\hmwkClass}{SDS\ 385} % Course/class
\newcommand{\hmwkClassTime}{} % Class/lecture time
\newcommand{\hmwkClassInstructor}{Professor Scott} % Teacher/lecturer
\newcommand{\hmwkAuthorName}{Spencer Woody} % Your name

\newcommand{\yhat}{\hat{y}}
\newcommand{\E}{\text{E}}

%----------------------------------------------------------------------------------------
%	TITLE PAGE
%----------------------------------------------------------------------------------------

\title{
\vspace{2in}
\textmd{\textbf{\hmwkClass:\ \hmwkTitle}}\\
\normalsize\vspace{0.1in}\small{\hmwkDueDate}\\
\vspace{0.1in}\large{\textit{\hmwkClassInstructor\ }}
\vspace{3in}
}

\author{\textbf{\hmwkAuthorName}}
\date{} % Insert date here if you want it to appear below your name

%----------------------------------------------------------------------------------------

\begin{document}

\maketitle

\newpage

%----------------------------------------------------------------------------------------
%	PROBLEM 1
%----------------------------------------------------------------------------------------

% To have just one problem per page, simply put a \clearpage after each problem

\begin{homeworkProblem}
\begin{enumerate}[(A)]
	%
	%
	%
	\item %%%%%%%%%%%%%% A
		From the previous excercise, we have the gradient of $\beta$
		%
		%
		%
		\begin{align}
		\nabla \ell (\beta) = \sum_{i=1}^N (m_iw_i-y_i)x_i.
		\end{align}
		%
		%
		%
		We can think of $m_iw_i$ as the fitted value of $y_i$, or $\yhat_i$, when given $\beta$, so the gradient becomes 
		%
		%
		%
		\begin{align}
			\nabla \ell (\beta) &= \sum_{i=1}^N (\yhat_i-y_i)x_i \\
			&= \sum_{i=1}^N g_i(\beta) \\
			g_i(\beta) &= (\yhat_i - y_i)x_i.
		\end{align}
		%
		%
		%
	\item %%%%%%%%%%%%%% B
	%
	%
	%
		\begin{align}
			\E(ng_i(\beta)) &= n \E(g_i(\beta))
		\end{align}
		%
		%
		%
		In this expectation, the only random variable is $i$ because the data $X$ and $y$ and the coefficients $\beta$ are all fixed. The variable $i$ is a random draw so it follows a discrete uniform distribution such that
		%
		%
		%
		\begin{align}
			P(i = j) =
			\begin{cases} 
			      \frac{1}{n} & j \in \{ 1, 2, \ldots, n \} \\
			      0 & \text{otherwise}.
			\end{cases}
		\end{align} 
		%
		%
		%
		Then we can compute the expectation.
		\begin{align}
			\E(g_i(\beta)) &= \sum_{j=1}^n g_j(\beta) P(i = j) \label{myeqn}\\
			&= \sum_{j=1}^n g_j(\beta) \frac{1}{n} \\
			&= \frac{1}{n} \sum_{j=1}^n g_j(\beta) \\
			&= \frac{1}{n} \nabla \ell (\beta), \\
			\Rightarrow \E(ng_i(\beta)) = n \E(g_i(\beta)) &= n \frac{1}{n} \nabla \ell (\beta) = \nabla \ell (\beta)
		\end{align}
	%
	%
	%
	\item %%%%%%%%%%%%%% C
	In this case, we perform SGD with $100,000$ iterations of samples with replacement and a step size $\alpha$ of $0.0001$. Our initial guess for $\beta$, $\hat{\beta}_0$ is some distance from the result of $\beta$ from Newton's method. That distance is 5 plus some noise from the $\text{Exp}(1)$ distribution in either the positive or negative direction. Trace plots of all elements of $\hat{\beta}_k$ for each iteration are shown below in Figure \ref{SGD}. The red horizontal lines represent the values of $\hat{\beta}$ obtained from Newton's method. 
	
	Also shown is trace plot of the exponential moving average (EMA) over the previous all iterations of the log-likelihood in Figure \ref{SGDlik}. Note that at each iteration, we are only computing the ``partial'' likelihood, that is, the likelihood using the randomly chosen data point and the newly computed $\hat{\beta}$ at that iteration. We use the EMA to reduce the level of noise in our log-likelihood plot. The EMA at the $k$th iteration, $S_k$, when the $i$th data point is sampled is calculated recursively by the formula $S_k = a \times \ell_i(\hat{\beta}_k) + (1-a) \times S_{k-1}$ with $S_1 = \ell_i(\beta_1)$, $a \in (0,1)$. We choose a small value of $a = 0.5 / n$ to reduce noise sufficiently and produce an interpretable graph.
	
	Interestingly, our likelihood seems to converge to stationarity fairly quickly, before the $20,000$th iteration. Most elements of $\hat{\beta}$ converge to their ``true''value by around the $10,000$th iteration and then bounce around that value for each subsequent iterations. However, not all of the elements of $\hat{beta}$ reach this point of convergence, specifically $\hat{\beta}_2$ and $\hat{\beta}_5$ shown in Figure \ref{SGD}. Despite this, our likelihood has still converged. This suggests that these coefficients have high variance (i.e., are ``insignificant'' to our model). $100,000$ iterations is significantly more than the number of iterations used in batch gradient descent (fewer than $50,000$) but this is still pretty remarkable considering that we only touch one data point at a time. 
	%
	%
	%
	\pagebreak
	\begin{align}
		\hat{\beta}_{t+1} = \hat{\beta}_t - \gamma \nabla \ell_i (\hat{\beta}_t)
	\end{align}
	%
	%
	%
	\begin{figure}%[htp!]
		\centering
		\includegraphics[scale=0.7]{SGDbetatrace.pdf}
		\caption{Trace plot of all elements of $\hat{\beta}$ from SGD}
		\label{SGD}
	\end{figure}
	\pagebreak
	%
	%
	%
	\begin{figure}%[htp!]
		\centering
		\includegraphics[scale=0.5]{SGDloglik.pdf}
		\caption{Trace plot of EMA of log-likelihood from SGD}
		\label{SGDlik}
	\end{figure}
	%
	%
	%
	\item %%%%%%%%%%%%%% D
	
	Now we substitute our fixed step size for a step size that decays over time. Here we use the Robbins-Monro rule for decaying step size, that is, 
	\begin{align}
		\gamma{t} = C(t + t_0)^{-alpha}.
	\end{align}
	In this case, we choose $C = 0.1$, $\alpha = 0.6$, and $t_0 = 1$. Trace plots for all elements of estimates $\hat{\beta}$ are shown in Figure \ref{SGDd}. We have a measured . The rationale for having a decaying step size is that we eventually get closer to the ``true'' values of $\hat{\beta}$ and then we our step sizes should decay so that we do not deviate too far from the . However, it appears to be the case for some of the $\hat{\beta}$s that our step size decays too rapidly before we reach the true values. For example, $\hat{\beta}_2$ in Figure \ref{SGDd} never gets close to its true value but the step size decays to the point where it can't jump back up. However, for the most part we have a tight distribution around the true values. Figure \ref{SGDlikd} shows the EMA for the partial log-likelihood.
	
	%
	%
	%
	%
	\begin{figure}[htp!]
		\centering
		\includegraphics[scale=0.7]{dSGDbetatrace.pdf}
		\caption{Trace plot of all elements of $\hat{\beta}$ from SGD with decaying step}
		\label{SGDd}
	\end{figure}
	%
	%
	%
	\begin{figure}[htp!]
		\centering
		\includegraphics[scale=0.5]{dSGDloglik.pdf}
		\caption{Trace plot of EMA of log-likelihood from SGD with decaying step}
		\label{SGDlikd}
	\end{figure}
	\pagebreak
	%
	%
	%
	\item %%%%%%%%%%%%%% E
	%
	%
	%
	Now, we incorporate. Remember that $\hat{\beta}$ eventually reaches a point of converging to the true values and then oscillates between that true value. Then, to get a final estimate, it makes sense to average out the estimates after some burn-in period with the Polyak-Ruppert (PR) averaging formula 
	\begin{align}
		\bar{\beta}^{(t)} = \frac{1}{t}\sum_{k=0}^{t-1}\beta^{(k)}.
	\end{align}
	Figure \ref{SGDPR} shows the result of PR-averaging with burn-in of the first two-thirds of estimates for SGD with a fixed stepsize, and Figure \ref{SGDlikPR} shows a trace plot of the corresponding log-likelihood for each iterated $\bar{\beta}^{(t)}$. We achieve a nice smooth decrease in the log-likelihood, and the averaging scheme gets us closer to the true values for most elements in $\hat{\beta}$, provided that we achieved convergence for those elements. Figure \ref{dSGDPR} and Figure \ref{dSGDlikPR} are the corresponding plots for SGD with decaying step size from the previous section.
	%
	%
	%
	\begin{figure}[htp!]
		\centering
		\includegraphics[scale=0.7]{SGDbetatracePR.pdf}
		\caption{Trace plot of all elements of $\hat{\beta}$ from SGD with PR-averaging}
		\label{SGDPR}
	\end{figure}
	%
	%
	%
	\begin{figure}[htp!]
		\centering
		\includegraphics[scale=0.5]{SGDloglikPR.pdf}
		\caption{Trace plot of EMA of log-likelihood from SGD with PR-averaging}
		\label{SGDlikPR}
			\pagebreak
	\end{figure}



	\begin{figure}[htp!]
		\centering
		\includegraphics[scale=0.7]{dSGDbetatracePR.pdf}
		\caption{Trace plot of all elements of $\hat{\beta}$ from SGD with decaying steps and PR-averaging}
		\label{dSGDPR}
	\end{figure}
	%
	%
	%
	\begin{figure}[htp!]
		\centering
		\includegraphics[scale=0.5]{dSGDloglikPR.pdf}
		\caption{Trace plot of EMA of log-likelihood from SGD with decaying steps and PR-averaging}
		\label{dSGDlikPR}
			\pagebreak
	\end{figure}
\end{enumerate}
\end{homeworkProblem}

R code is shown in the appendix of this report.



%%----------------------------------------------------------------------------------------
%%	LIST CODE
%%----------------------------------------------------------------------------------------

\pagebreak
\pagebreak
%\rscript{homework03.r}{Sample Perl Script With Highlighting}
\lstinputlisting[language=R]{SGD.R}

%----------------------------------------------------------------------------------------

\end{document}